name: Auto-Triage New Issues

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  triage:
    runs-on: ubuntu-latest
    name: Auto-triage issue with AI

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd src/TeamAssistant/backend
          pip install -r requirements.txt

      - name: Run triage analysis
        id: triage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_MODELS_KEY: ${{ secrets.GITHUB_MODELS_KEY }}
          GITHUB_MODELS_ENDPOINT: https://models.inference.ai.azure.com
          GITHUB_MODELS_MODEL: gpt-4o-mini
        run: |
          cd src/TeamAssistant/backend
          python scripts/triage_issue.py \
            --owner "${{ github.repository_owner }}" \
            --repo "${{ github.event.repository.name }}" \
            --issue-number "${{ github.event.issue.number }}"

      - name: Post triage results
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read triage result
            let triageResult;
            try {
              triageResult = JSON.parse(fs.readFileSync('/tmp/triage_result.json', 'utf8'));
            } catch (error) {
              console.log('No triage result file found, skipping comment');
              return;
            }

            // Format rationale
            let rationaleText = 'No rationale provided';
            if (triageResult.rationale) {
              if (typeof triageResult.rationale === 'object') {
                rationaleText = Object.entries(triageResult.rationale)
                  .map(([key, value]) => `**${key.replace(/_/g, ' ')}:** ${value}`)
                  .join('\n\n');
              } else {
                rationaleText = triageResult.rationale;
              }
            }

            // Build comment body
            let comment = '## ðŸ¤– Auto-Triage Results\n\n';
            comment += `**Classification:** ${triageResult.issue_type || 'Unknown'}\n`;
            comment += `**Priority:** ${triageResult.priority || 'P3'}\n`;
            comment += `**Confidence:** ${triageResult.confidence ? (triageResult.confidence * 100).toFixed(1) + '%' : 'N/A'}\n\n`;

            if (triageResult.recommended_assignee) {
              comment += `**Recommended Assignee:** @${triageResult.recommended_assignee}\n\n`;
            }

            comment += '**Analysis:**\n';
            comment += rationaleText + '\n\n';

            if (triageResult.is_copilot_fixable) {
              comment += 'âœ… This issue appears to be Copilot-fixable!\n\n';
            }

            comment += '---\n*Generated by TeamAssistant Auto-Triage powered by GitHub Models*';

            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

            // Add labels if available
            const labels = [];
            if (triageResult.priority) {
              labels.push(triageResult.priority);
            }
            if (triageResult.issue_type) {
              labels.push(triageResult.issue_type.toLowerCase());
            }

            if (labels.length > 0) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: labels
                });
              } catch (error) {
                console.log('Failed to add labels (may not exist):', error.message);
              }
            }

            // Assign if recommended
            if (triageResult.recommended_assignee) {
              try {
                await github.rest.issues.addAssignees({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  assignees: [triageResult.recommended_assignee]
                });
              } catch (error) {
                console.log('Failed to assign user:', error.message);
              }
            }
